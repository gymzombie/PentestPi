##!/bin/bash
#
# Initial Setup for Pentest Pi
# 
# run once, but should be safe to re-run
# 
# Inspiration borrowed from https://github.com/secgroundzero/warberry/
#

# List of "Other" tools that we'll install through apt-get
APTTOOLS="nbtscan python-scapy tcpdump nmap tmux metasploit-framework exploitdb \
monit git curl"

# List of handy tools that we'll be syncing from git into /opt/
GITTOOLS="https://github.com/ChrisTruncer/EyeWitness.git
https://github.com/alobbs/macchanger.git
https://github.com/lgandx/Responder.git
https://github.com/gymzombie/PentestPi.git"

# Give our user one last opt-out
echo """This script will change your system in many ways, including installing applications,
  creating user accounts, creating and maintaining services, collecting user credentials,
  and sending those credentials and opening a shell to a command and control server that
  you maintain. 
  
  If you do not understand this or are unsure, exit now. If you would like to
  continue, type YES:

  ::"""
read decision
if [ $decision != "YES" ]; then
  echo "A safe choice. Come back later!"
  exit 1
fi

if [ "$(id -u)" != "0" ]; then
  echo "ERROR: Sorry, you are not root. Run this script as root or with sudo."
  exit 1
fi


echo """
  Updating Distro...
  """

apt-get update -y
apt-get upgrade -y


echo """
  Installing necessary tools...
  """

for each in $APTTOOLS; do
  apt-get install $each -y
done


echo """
  Installing git tools in /opt
  """

for each in $GITTOOLS; do
  git clone $each
done

echo """
  Changing your system\'s default SSH Keys
  """
rm /etc/ssh/ssh_host_*
dpkg-reconfigure openssh-server
service ssh restart


echo """
  Disabling IPV6
  """
if grep -q 'net.ipv6.conf.all.disable_ipv6' /etc/sysctl.d/local.conf
  then
    echo 'net.ipv6.conf.all.disable_ipv6 already disabled, moving to next'
    exit
  else
    echo 'Setting net.ipv6.conf.all.disable_ipv6 to blocking mode'
    echo 'net.ipv6.conf.all.disable_ipv6 = 1' >> etc/sysctl.d/local.conf
fi
if grep -q 'net.ipv6.conf.default.disable_ipv6' /etc/sysctl.d/local.conf
  then    
    echo 'net.ipv6.conf.default.disable_ipv6 already disabled, moving to next'
    exit
  else
    echo 'Setting net.ipv6.conf.default.disable_ipv6 to blocking mode'
    echo 'net.ipv6.conf.default.disable_ipv6 = 1' >> etc/sysctl.d/local.conf
fi
if grep -q 'net.ipv6.conf.lo.disable_ipv6' /etc/sysctl.d/local.conf
  then    
    echo 'net.ipv6.conf.lo.disable_ipv6 already disabled, moving to next'
    exit
  else
    echo 'Setting net.ipv6.conf.lo.disable_ipv6 to blocking mode'
    echo 'net.ipv6.conf.lo.disable_ipv6 = 1' >> etc/sysctl.d/local.conf
fi

echo """
  Creating user \'raspi\' if one doesn\'t exist already
  """
  
id -u raspi &>/dev/null || useradd raspi --home-dir /home/raspi/ --create-home 
  # And generate SSH keys for that user
mkdir /home/raspi/.ssh
chmod 700 .ssh
chown raspi /home/raspi/.ssh
sudo -H -u raspi bash -c 'ssh-keygen -t rsa -f /home/raspi/.ssh/id_rsa -N ""'


echo """
  Run this command to upload your authorized key. Password will be what you created on 
  the C&C Server:
  
  scp id_rsa.pub raspi@<yourhost>:.ssh/authorized_keys
  
  Then edit pentest-config.sh to update HOME_SERVER address
  
  And if you haven't yet... Change your root password!
  
  """
  
